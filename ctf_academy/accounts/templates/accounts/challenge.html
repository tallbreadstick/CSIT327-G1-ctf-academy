{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CTF Desktop</title>
{% tailwind_css %}

<link rel="stylesheet" href="{% static 'accounts/css/challenge.css' %}">
<script defer src="{% static 'accounts/js/favorites.js' %}"></script>
<!-- challenge.js is loaded at end of body so it can attach to DOM elements created below -->
</head>

<body id="desktop-body"
    class="m-0 p-0 h-screen w-screen font-mono relative overflow-hidden desktop-locked">

<!-- Hidden CSRF form to ensure csrftoken cookie is set for JS fetch calls -->
<form method="post" style="display:none;">{% csrf_token %}</form>

<!-- ==============================
     DESKTOP WORKSPACE
     ============================== -->
<div class="desktop-area" data-readonly="{{ readonly|yesno:'true,false' }}" data-save-url="{{ save_progress_url }}">
    {% if readonly %}
    <div class="absolute top-0 left-0 right-0 z-50 text-center bg-yellow-500/20 text-yellow-300 text-xs py-1">
        Read-only mode: interactions may be disabled.
    </div>
    {% endif %}

    <!-- NOTE: DWM will inject windows here -->
    <!-- Floating per-challenge controls (favorite) still present and anchored to desktop-area -->
    <button
        class="absolute top-4 right-4 p-1 rounded bg-black/40 hover:bg-black/60 z-50"
        title="Toggle favorite"
        aria-label="Toggle favorite"
        aria-pressed="{{ is_favorite|yesno:'true,false' }}"
        data-action="toggle-favorite"
        data-toggle-url="{% url 'toggle_favorite' challenge.id %}"
        data-challenge-id="{{ challenge.id }}"
        data-favorited="{{ is_favorite|yesno:'1,0' }}">
        <i class="{% if is_favorite %}fas text-yellow-400{% else %}far text-gray-300{% endif %} fa-star text-2xl"></i>
    </button>

    <!-- desktop windows container (windows appended inside here by DWM) -->
    <div id="windows-root" class="w-full h-full relative"></div>
</div>

<!-- ==============================
     TASKBAR
     ============================== -->
<div class="taskbar">
    <div class="taskbar-left">
        <div class="power-wrapper">
            <button id="power-btn" class="taskbar-icon power-button">â»</button>
            <div id="power-dropdown" class="dropdown-panel dropdown-hidden">
                <button data-url="{% url 'logout_page' %}">Log Out</button>
                <button data-url="{% url 'challenges_page' %}">Power Off</button>
                <button data-action="restart">Restart</button>
            </div>
        </div>
        <button class="taskbar-icon appgrid-button">â‹®â‹®â‹®</button>
    </div>
    <div class="taskbar-center">
        <!-- data-app values used by DWM to spawn app windows -->
        <button class="taskbar-icon" data-app="text" title="Open Text (Notes)">ğŸ“„</button>
        <button class="taskbar-icon" data-app="terminal" title="Open Terminal">ğŸ–¥ï¸</button>
        <button class="taskbar-icon" data-app="browser" title="Open Browser (placeholder)">ğŸŒ</button>
        <button class="taskbar-icon" data-app="files" title="Open Files (placeholder)">ğŸ“</button>
    </div>
    <div class="taskbar-right">
        <span id="clock" class="clock-text">00:00</span>
    </div>
</div>

<!-- ==============================
     LOADING SCREEN (unchanged)
     ============================== -->
<div id="loading-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black text-white text-2xl font-bold transition-opacity duration-500">
    <div class="animate-pulse mb-6" id="loading-message">Loading your challenge...</div>
    <div id="loading-extra" class="text-sm text-gray-400 opacity-50">Initializing environment...</div>
</div>

<!-- ==============================
     FULLSCREEN PROMPT (unchanged)
     ============================== -->
<div id="fullscreen-prompt" 
     class="fixed inset-0 z-50 flex items-center justify-center bg-black text-white text-2xl font-bold cursor-pointer transition-opacity duration-500 opacity-0 pointer-events-none">
    Click anywhere to continue...
</div>

<!-- Expose initial text content to JS safely -->
<script>
    const INITIAL_TEXT = "{{ initial_text_content|default:''|escapejs }}";
    const IS_READONLY = "{{ readonly|yesno:'true,false' }}" === "true";
    const UPDATE_STATUS_URL = "{{ update_status_url|escapejs }}";
    // Expose CSRF token directly if needed by JS (fallback if cookie missing)
    window.CSRF_TOKEN = '{{ csrf_token }}';
</script>

<!-- load DWM + app logic (deferred to end of body) -->
<script defer src="{% static 'accounts/js/challenge.js' %}"></script>

<!-- script to enable fullscreen stuff -->
<script defer src="{% static 'accounts/js/fullscreen.js' %}"></script>
</body>
</html>
