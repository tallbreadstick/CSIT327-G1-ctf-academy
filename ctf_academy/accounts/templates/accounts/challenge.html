{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CTF Desktop</title>
{% tailwind_css %}

<link rel="stylesheet" href="{% static 'accounts/css/challenge.css' %}">
<script defer src="{% static 'accounts/js/challenge.js' %}"></script>
<script defer src="{% static 'accounts/js/favorites.js' %}"></script>

</head>

<body id="desktop-body"
    class="m-0 p-0 h-screen w-screen font-mono relative overflow-hidden">

<!-- ==============================
     DESKTOP WORKSPACE
     ============================== -->
<div class="desktop-area" data-readonly="{{ readonly|yesno:'true,false' }}" data-save-url="{{ save_progress_url }}">
    {% if readonly %}
    <div class="absolute top-0 left-0 right-0 z-50 text-center bg-yellow-500/20 text-yellow-300 text-xs py-1">
        Read-only mode: interactions may be disabled.
    </div>
    {% endif %}
    <!-- Favorite toggle floating button -->
    <button
        class="absolute top-4 right-4 p-1 rounded bg-black/40 hover:bg-black/60"
        title="Toggle favorite"
        aria-label="Toggle favorite"
        aria-pressed="{{ is_favorite|yesno:'true,false' }}"
        data-action="toggle-favorite"
        data-toggle-url="{% url 'toggle_favorite' challenge.id %}"
        data-challenge-id="{{ challenge.id }}"
        data-favorited="{{ is_favorite|yesno:'1,0' }}">
        <i class="{% if is_favorite %}fas text-yellow-400{% else %}far text-gray-300{% endif %} fa-star text-2xl"></i>
    </button>
    <c-text 
        editor_id="welcome-editor" 
        editor_title="Welcome.txt"
        content="{{ initial_text_content }}">
    </c-text>
    {% if not readonly %}
    <c-terminal
        terminal_id="terminal-default"
        terminal_title="Terminal"
        default_open="true">
    </c-terminal>
    {% endif %}
</div>

<!-- ==============================
     TASKBAR
     ============================== -->
<div class="taskbar">
    <div class="taskbar-left">
        <div class="power-wrapper">
            <button id="power-btn" class="taskbar-icon power-button">â»</button>
            <div id="power-dropdown" class="dropdown-panel dropdown-hidden">
                <button data-url="{% url 'logout_page' %}">Log Out</button>
                <button data-url="{% url 'challenges_page' %}">Power Off</button>
                <button data-action="restart">Restart</button>
            </div>
        </div>
        <button class="taskbar-icon appgrid-button">â‹®â‹®â‹®</button>
    </div>
    <div class="taskbar-center">
        <button class="taskbar-icon" onclick="openWindow('notes-window')">ğŸ“„</button>
        <button class="taskbar-icon">ğŸ–¥ï¸</button>
        <button class="taskbar-icon">ğŸŒ</button>
        <button class="taskbar-icon">ğŸ“</button>
    </div>
    <div class="taskbar-right">
        <span id="clock" class="clock-text">00:00</span>
    </div>
</div>

<!-- ==============================
     LOADING SCREEN
     ============================== -->
<div id="loading-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black text-white text-2xl font-bold transition-opacity duration-500">
    <div class="animate-pulse mb-6" id="loading-message">Loading your challenge...</div>
    <div id="loading-extra" class="text-sm text-gray-400 opacity-50">Initializing environment...</div>
</div>

<!-- ==============================
     FULLSCREEN PROMPT
     ============================== -->
<div id="fullscreen-prompt" 
     class="fixed inset-0 z-50 flex items-center justify-center bg-black text-white text-2xl font-bold cursor-pointer transition-opacity duration-500 opacity-0 pointer-events-none">
    Click anywhere to continue...
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const loading = document.getElementById("loading-screen");
    const fullscreenPrompt = document.getElementById("fullscreen-prompt");
    const loadingExtra = document.getElementById("loading-extra");

    // Animate loading messages
    const extraMessages = [
        "Loading modules...",
        "Fetching challenge data...",
        "Preparing your desktop...",
        "Almost ready..."
    ];
    let msgIndex = 0;
    const msgInterval = setInterval(() => {
        if (msgIndex < extraMessages.length) {
            loadingExtra.textContent = extraMessages[msgIndex];
            msgIndex++;
        } else {
            clearInterval(msgInterval);
        }
    }, 800);

    // 1ï¸âƒ£ Keep loading screen visible for 4 seconds
    setTimeout(() => {
        // 2ï¸âƒ£ Fade out loading screen
        if (loading) {
            loading.classList.add("opacity-0", "pointer-events-none");
            setTimeout(() => loading.remove(), 500);
        }

        // 3ï¸âƒ£ Type editor content after loading fade
        const editor = document.querySelector("#welcome-editor textarea");
        if (editor && editor.textContent) {
            const text = editor.textContent;
            editor.value = "";
            let i = 0;
            const interval = setInterval(() => {
                editor.value += text[i];
                i++;
                if (i >= text.length) clearInterval(interval);
            }, 15);
        }

        // 4ï¸âƒ£ Show fullscreen prompt AFTER loading screen completely disappears
        setTimeout(() => {
            fullscreenPrompt.classList.remove("opacity-0", "pointer-events-none");
            fullscreenPrompt.classList.add("opacity-100", "pointer-events-auto");
        }, 500); // 0.5s fade buffer

    }, 4000); // 4s loading duration

    // 5ï¸âƒ£ Fullscreen trigger on click
    fullscreenPrompt.addEventListener("click", () => {
        const el = document.documentElement;
        if (el.requestFullscreen) el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        else if (el.msRequestFullscreen) el.msRequestFullscreen();

        fullscreenPrompt.classList.add("opacity-0", "pointer-events-none");
        setTimeout(() => fullscreenPrompt.remove(), 500);
    });
});
</script>

</body>
</html>
