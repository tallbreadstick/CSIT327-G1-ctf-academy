{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CTF Academy - AI Assistant</title>
    <link rel="icon" type="image/png" href="{% static 'accounts/images/logo.png' %}">
    {% tailwind_css %}

    <style>
        html, body {
            overflow: auto !important;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bg-pan {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }
        .fade-up { animation: fadeInUp 1s ease-out forwards; }
        .glow-text {
            background: linear-gradient(90deg, #ec4899, #f9a8d4, #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: bg-pan 8s linear infinite;
        }
        .chat-container {
            height: calc(100vh - 300px);
            min-height: 400px;
        }
        .message-user {
            background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
        }
        .message-bot {
            background: #1f2937;
            border: 1px solid #374151;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen relative overflow-hidden">

    <!-- BACKGROUND EFFECT -->
    <div class="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_center,#ec4899,transparent_70%)] animate-pulse"></div>

    <!-- NAVBAR -->
    <c-navbar></c-navbar>

    <!-- MAIN CONTENT -->
    <main class="flex-grow flex flex-col items-center px-6 py-10 relative z-10">
        <div class="w-full max-w-4xl">
            <!-- Header -->
            <div class="text-center mb-8 fade-up">
                <h1 class="text-5xl font-extrabold mb-4 glow-text">
                    CTF Academy AI Assistant
                </h1>
                <p class="text-gray-300 text-lg">
                    Ask me anything about cybersecurity, CTF challenges, or how to use the platform!
                </p>
            </div>

            <!-- Chat Container -->
            <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 fade-up" style="animation-delay:0.3s;">
                <!-- Messages Area -->
                <div id="chat-messages" class="chat-container overflow-y-auto mb-4 space-y-4 px-2">
                    <!-- Welcome Message -->
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <img src="{% static 'accounts/images/logo.png' %}" alt="Bot" class="h-8 w-8 rounded-full">
                        </div>
                        <div class="message-bot rounded-2xl px-4 py-3 max-w-[80%]">
                            <p class="text-gray-100">
                                ðŸ‘‹ Hey there! I'm your CTF Academy assistant. I can help you with:
                            </p>
                            <ul class="mt-2 text-gray-300 text-sm space-y-1">
                                <li>â€¢ Cybersecurity concepts and techniques</li>
                                <li>â€¢ Tips for solving CTF challenges</li>
                                <li>â€¢ Platform features and navigation</li>
                                <li>â€¢ General offensive security questions</li>
                            </ul>
                            <p class="mt-2 text-gray-300 text-sm">What would you like to know?</p>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="flex items-center space-x-3">
                    <input 
                        type="text" 
                        id="user-input" 
                        placeholder="Type your message here..."
                        class="flex-1 bg-gray-700 text-white rounded-full px-6 py-3 focus:outline-none focus:ring-2 focus:ring-pink-500"
                        autocomplete="off"
                    >
                    <button 
                        id="send-btn"
                        class="bg-pink-600 hover:bg-pink-700 text-white rounded-full px-6 py-3 font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Send
                    </button>
                </div>

                <!-- Loading Indicator -->
                <div id="loading" class="hidden mt-4 flex items-center justify-center space-x-2">
                    <div class="animate-bounce bg-pink-500 rounded-full h-2 w-2"></div>
                    <div class="animate-bounce bg-pink-500 rounded-full h-2 w-2" style="animation-delay: 0.1s;"></div>
                    <div class="animate-bounce bg-pink-500 rounded-full h-2 w-2" style="animation-delay: 0.2s;"></div>
                    <span class="text-gray-400 text-sm ml-2">Thinking...</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="mt-6 flex flex-wrap gap-3 justify-center fade-up" style="animation-delay:0.6s;">
                <button class="quick-question bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-full text-sm transition">
                    How do I start my first CTF challenge?
                </button>
                <button class="quick-question bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-full text-sm transition">
                    What is SQL injection?
                </button>
                <button class="quick-question bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-full text-sm transition">
                    How do leaderboards work?
                </button>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <c-footer></c-footer>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const loading = document.getElementById('loading');
        const quickQuestions = document.querySelectorAll('.quick-question');

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function addMessage(content, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-3 ' + (isUser ? 'justify-end' : '');
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="message-user rounded-2xl px-4 py-3 max-w-[80%]">
                        <p class="text-white">${escapeHtml(content)}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0">
                        <img src="{% static 'accounts/images/logo.png' %}" alt="Bot" class="h-8 w-8 rounded-full">
                    </div>
                    <div class="message-bot rounded-2xl px-4 py-3 max-w-[80%]">
                        <p class="text-gray-100">${formatMessage(content)}</p>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessage(text) {
            // Simple markdown-like formatting
            text = escapeHtml(text);
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        async function sendMessage(message) {
            if (!message.trim()) return;

            // Add user message
            addMessage(message, true);
            userInput.value = '';
            sendBtn.disabled = true;
            loading.classList.remove('hidden');

            try {
                const response = await fetch('{% url "chatbot_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();

                if (data.success) {
                    addMessage(data.response, false);
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', false);
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('Sorry, something went wrong. Please try again.', false);
            } finally {
                loading.classList.add('hidden');
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        // Event listeners
        sendBtn.addEventListener('click', () => {
            sendMessage(userInput.value);
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(userInput.value);
            }
        });

        quickQuestions.forEach(btn => {
            btn.addEventListener('click', () => {
                sendMessage(btn.textContent);
            });
        });

        // Focus input on load
        userInput.focus();
    </script>

</body>
</html>