{% load static %}
<!-- Floating Chatbot Component -->
<div id="chatbot-container" class="fixed bottom-4 right-4 z-[9999]">
    <!-- Chatbot Window (Hidden by default) -->
    <div id="chatbot-window" class="hidden mb-4 bg-gray-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-pink-500/30" style="width: 450px; height: 600px;">
        <!-- Header -->
        <div class="bg-gradient-to-r from-pink-600 to-pink-700 px-4 py-3 flex items-center justify-between flex-shrink-0">
            <div class="flex items-center space-x-2">
                <img src="{% static 'accounts/images/logo.png' %}" alt="AI" class="h-8 w-8 rounded-full">
                <div>
                    <h3 class="text-white font-semibold text-sm">CTF AI Assistant</h3>
                    <p class="text-pink-100 text-xs">Ask me anything!</p>
                </div>
            </div>
            <button id="chatbot-close" class="text-white hover:text-pink-200 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>

        <!-- Messages Area -->
        <div id="chatbot-messages" class="overflow-y-auto p-4 space-y-3 bg-gray-900 flex-1" style="min-height: 0;">
            <!-- Welcome Message -->
            <div class="flex items-start space-x-2">
                <div class="h-6 w-6 rounded-full bg-gradient-to-br from-pink-500 to-pink-600 flex items-center justify-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="bg-gray-800 rounded-2xl px-3 py-2 max-w-[85%] border border-gray-700">
                    <p class="text-gray-100 text-sm">
                        ðŸ‘‹ Hey! I'm your CTF Academy AI assistant. I can help with:
                    </p>
                    <ul class="mt-2 text-gray-300 text-xs space-y-1">
                        <li>â€¢ Cybersecurity concepts & techniques</li>
                        <li>â€¢ CTF challenge tips & hints</li>
                        <li>â€¢ Platform features & navigation</li>
                        <li>â€¢ Offensive security questions</li>
                    </ul>
                    <p class="mt-2 text-gray-400 text-xs">Try asking me something or use the quick questions below!</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="px-4 py-2 bg-gray-800/50 border-t border-gray-700 flex-shrink-0">
            <div class="flex flex-wrap gap-2">
                <button class="chatbot-quick-question text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-full transition">
                    SQL injection basics
                </button>
                <button class="chatbot-quick-question text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-full transition">
                    How do leaderboards work?
                </button>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-gray-800 border-t border-gray-700 flex-shrink-0">
            <div class="flex items-center space-x-2">
                <input 
                    type="text" 
                    id="chatbot-input" 
                    placeholder="Type your message..."
                    class="flex-1 bg-gray-700 text-white text-sm rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500"
                    autocomplete="off"
                >
                <button 
                    id="chatbot-send"
                    class="bg-pink-600 hover:bg-pink-700 text-white rounded-full p-2 transition disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </div>
            
            <!-- Loading Indicator -->
            <div id="chatbot-loading" class="hidden mt-2 flex items-center space-x-2">
                <div class="animate-bounce bg-pink-500 rounded-full h-1.5 w-1.5"></div>
                <div class="animate-bounce bg-pink-500 rounded-full h-1.5 w-1.5" style="animation-delay: 0.1s;"></div>
                <div class="animate-bounce bg-pink-500 rounded-full h-1.5 w-1.5" style="animation-delay: 0.2s;"></div>
                <span class="text-gray-400 text-xs ml-2">Thinking...</span>
            </div>
        </div>
    </div>

    <!-- Floating Button -->
    <button id="chatbot-toggle" 
            class="bg-red-500 hover:bg-red-600 text-white rounded-full p-4 shadow-2xl 
                   transition-all hover:scale-110 group animate-pulse-slow">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            <circle cx="9" cy="10" r="0.5" fill="white" stroke="none"/>
            <circle cx="12" cy="10" r="0.5" fill="white" stroke="none"/>
            <circle cx="15" cy="10" r="0.5" fill="white" stroke="none"/>
            <line x1="9" y1="10" x2="9.01" y2="10" stroke-width="2"/>
            <line x1="12" y1="10" x2="12.01" y2="10" stroke-width="2"/>
            <line x1="15" y1="10" x2="15.01" y2="10" stroke-width="2"/>
        </svg>

        <span class="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-gray-800 text-white px-3 py-2 
                     rounded-lg text-sm whitespace-nowrap opacity-0 group-hover:opacity-100 
                     transition-opacity pointer-events-none shadow-lg">
            Ask our AI Assistant
        </span>

        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 
                     flex items-center justify-center animate-pulse">
            AI
        </span>
    </button>
</div>

<style>
@keyframes pulse-slow {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
    50% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
}
.animate-pulse-slow {
    animation: pulse-slow 2s infinite;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.chat-window-enter {
    animation: slideUp 0.3s ease-out forwards;
}

@keyframes slideDown {
    from {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    to {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
}

.chat-window-exit {
    animation: slideDown 0.2s ease-in forwards;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-enter {
    animation: fadeInUp 0.4s ease-out;
}

@keyframes typingDot {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

.typing-indicator {
    display: inline-block;
    animation: typingDot 1.4s infinite;
}

.typing-indicator:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator:nth-child(3) {
    animation-delay: 0.4s;
}
</style>

<script>
(function() {
    const container = document.getElementById('chatbot-container');
    const window = document.getElementById('chatbot-window');
    const toggle = document.getElementById('chatbot-toggle');
    const close = document.getElementById('chatbot-close');
    const messages = document.getElementById('chatbot-messages');
    const input = document.getElementById('chatbot-input');
    const sendBtn = document.getElementById('chatbot-send');
    const loading = document.getElementById('chatbot-loading');
    const quickQuestions = document.querySelectorAll('.chatbot-quick-question');

    // Session storage keys
    const STORAGE_KEY = 'ctf_chatbot_history';
    const WINDOW_STATE_KEY = 'ctf_chatbot_window_state';

    // Load chat history from session storage
    function loadChatHistory() {
        try {
            const history = sessionStorage.getItem(STORAGE_KEY);
            if (history) {
                const chatHistory = JSON.parse(history);
                // Clear existing messages except welcome message
                const welcomeMsg = messages.querySelector('.flex.items-start.space-x-2');
                messages.innerHTML = '';
                if (welcomeMsg) {
                    messages.appendChild(welcomeMsg);
                }
                // Restore messages
                chatHistory.forEach(msg => {
                    addMessage(msg.content, msg.isUser, false);
                });
            }
        } catch (error) {
            console.error('Failed to load chat history:', error);
        }
    }

    // Save chat history to session storage
    function saveChatHistory() {
        try {
            const messageElements = messages.querySelectorAll('.flex.items-start');
            const history = [];
            
            messageElements.forEach(el => {
                // Skip the welcome message
                if (el.querySelector('.text-gray-400')) return;
                
                const isUser = el.classList.contains('justify-end');
                const textEl = el.querySelector('p');
                if (textEl) {
                    history.push({
                        content: textEl.innerHTML,
                        isUser: isUser
                    });
                }
            });
            
            sessionStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        } catch (error) {
            console.error('Failed to save chat history:', error);
        }
    }

    // Load window state
    function loadWindowState() {
        try {
            const state = sessionStorage.getItem(WINDOW_STATE_KEY);
            if (state === 'open') {
                window.classList.remove('hidden');
                toggle.classList.add('hidden');
            }
        } catch (error) {
            console.error('Failed to load window state:', error);
        }
    }

    // Save window state
    function saveWindowState(isOpen) {
        try {
            sessionStorage.setItem(WINDOW_STATE_KEY, isOpen ? 'open' : 'closed');
        } catch (error) {
            console.error('Failed to save window state:', error);
        }
    }

    // Initialize - load saved state
    loadChatHistory();
    loadWindowState();

    // Toggle chatbot window
    toggle.addEventListener('click', () => {
        const isHidden = window.classList.contains('hidden');
        if (isHidden) {
            window.classList.remove('hidden');
            window.classList.add('chat-window-enter');
            toggle.classList.add('hidden');
            saveWindowState(true);
            input.focus();
            
            // Remove animation class after it completes
            setTimeout(() => {
                window.classList.remove('chat-window-enter');
            }, 300);
        }
    });

    // Close chatbot
    close.addEventListener('click', () => {
        window.classList.add('chat-window-exit');
        
        setTimeout(() => {
            window.classList.add('hidden');
            window.classList.remove('chat-window-exit');
            toggle.classList.remove('hidden');
            saveWindowState(false);
        }, 200);
    });

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatMessage(text) {
        text = escapeHtml(text);
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        text = text.replace(/\n/g, '<br>');
        return text;
    }

    function addMessage(content, isUser, shouldSave = true) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start space-x-2 message-enter ' + (isUser ? 'justify-end' : '');
        
        if (isUser) {
            messageDiv.innerHTML = `
                <div class="bg-gradient-to-r from-pink-600 to-pink-700 rounded-2xl px-3 py-2 max-w-[85%]">
                    <p class="text-white text-sm">${escapeHtml(content)}</p>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="h-6 w-6 rounded-full bg-gradient-to-br from-pink-500 to-pink-600 flex items-center justify-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="bg-gray-800 rounded-2xl px-3 py-2 max-w-[85%] border border-gray-700">
                    <p class="text-gray-100 text-sm">${formatMessage(content)}</p>
                </div>
            `;
        }
        
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
        
        // Save to session storage
        if (shouldSave) {
            saveChatHistory();
        }
    }

    function addTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'flex items-start space-x-2 message-enter';
        typingDiv.innerHTML = `
            <div class="h-6 w-6 rounded-full bg-gradient-to-br from-pink-500 to-pink-600 flex items-center justify-center flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="bg-gray-800 rounded-2xl px-4 py-3 border border-gray-700 flex items-center space-x-1">
                <div class="typing-indicator w-2 h-2 bg-pink-500 rounded-full"></div>
                <div class="typing-indicator w-2 h-2 bg-pink-500 rounded-full"></div>
                <div class="typing-indicator w-2 h-2 bg-pink-500 rounded-full"></div>
            </div>
        `;
        messages.appendChild(typingDiv);
        messages.scrollTop = messages.scrollHeight;
    }

    function removeTypingIndicator() {
        const typingDiv = document.getElementById('typing-indicator');
        if (typingDiv) {
            typingDiv.remove();
        }
    }

    async function sendMessage(message) {
        if (!message.trim()) return;

        addMessage(message, true);
        input.value = '';
        sendBtn.disabled = true;
        loading.classList.remove('hidden');
        
        // Add typing indicator
        addTypingIndicator();

        try {
            const response = await fetch('{% url "chatbot_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();
            console.log('Chatbot API response:', data);

            // Remove typing indicator before showing response
            removeTypingIndicator();

            // Handle the nested response format: {success: true, data: {response: "..."}}
            if (data.success && data.data && data.data.response) {
                addMessage(data.data.response, false);
            } else if (data.ok && data.data && data.data.response) {
                addMessage(data.data.response, false);
            } else if (data.response) {
                addMessage(data.response, false);
            } else {
                console.error('Unexpected response format:', data);
                addMessage('Sorry, I encountered an error. Please try again.', false);
            }
        } catch (error) {
            console.error('Chatbot error:', error);
            removeTypingIndicator();
            addMessage('Sorry, something went wrong. Please try again.', false);
        } finally {
            loading.classList.add('hidden');
            sendBtn.disabled = false;
            input.focus();
        }
    }

    // Event listeners
    sendBtn.addEventListener('click', () => {
        sendMessage(input.value);
    });

    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage(input.value);
        }
    });

    quickQuestions.forEach(btn => {
        btn.addEventListener('click', () => {
            sendMessage(btn.textContent.trim());
        });
    });
})();
</script>