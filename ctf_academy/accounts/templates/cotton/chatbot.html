{% load static %}
<!-- Floating Chatbot Component -->
<div id="chatbot-container" class="fixed bottom-4 right-4 z-[9999]">
    <!-- Chatbot Window (Hidden by default) -->
    <div id="chatbot-window" class="hidden mb-4 bg-gray-800 rounded-2xl shadow-2xl w-96 max-h-[600px] flex flex-col overflow-hidden border border-pink-500/30">
        <!-- Header -->
        <div class="bg-gradient-to-r from-pink-600 to-pink-700 px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <img src="{% static 'accounts/images/logo.png' %}" alt="AI" class="h-8 w-8 rounded-full">
                <div>
                    <h3 class="text-white font-semibold text-sm">CTF AI Assistant</h3>
                    <p class="text-pink-100 text-xs">Ask me anything!</p>
                </div>
            </div>
            <button id="chatbot-close" class="text-white hover:text-pink-200 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>

        <!-- Messages Area -->
        <div id="chatbot-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-900">
            <!-- Welcome Message -->
            <div class="flex items-start space-x-2">
                <div class="h-6 w-6 rounded-full bg-gradient-to-br from-pink-500 to-pink-600 flex items-center justify-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="bg-gray-800 rounded-2xl px-3 py-2 max-w-[85%] border border-gray-700">
                    <p class="text-gray-100 text-sm">
                        ðŸ‘‹ Hey! I'm your CTF Academy AI assistant. I can help with:
                    </p>
                    <ul class="mt-2 text-gray-300 text-xs space-y-1">
                        <li>â€¢ Cybersecurity concepts & techniques</li>
                        <li>â€¢ CTF challenge tips & hints</li>
                        <li>â€¢ Platform features & navigation</li>
                        <li>â€¢ Offensive security questions</li>
                    </ul>
                    <p class="mt-2 text-gray-400 text-xs">Try asking me something or use the quick questions below!</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="px-4 py-2 bg-gray-800/50 border-t border-gray-700">
            <div class="flex flex-wrap gap-2">
                <button class="chatbot-quick-question text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-full transition">
                    SQL injection basics
                </button>
                <button class="chatbot-quick-question text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-full transition">
                    How do leaderboards work?
                </button>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-gray-800 border-t border-gray-700">
            <div class="flex items-center space-x-2">
                <input 
                    type="text" 
                    id="chatbot-input" 
                    placeholder="Type your message..."
                    class="flex-1 bg-gray-700 text-white text-sm rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500"
                    autocomplete="off"
                >
                <button 
                    id="chatbot-send"
                    class="bg-pink-600 hover:bg-pink-700 text-white rounded-full p-2 transition disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </div>
            
            <!-- Loading Indicator -->
            <div id="chatbot-loading" class="hidden mt-2 flex items-center space-x-2">
                <div class="animate-bounce bg-pink-500 rounded-full h-1.5 w-1.5"></div>
                <div class="animate-bounce bg-pink-500 rounded-full h-1.5 w-1.5" style="animation-delay: 0.1s;"></div>
                <div class="animate-bounce bg-pink-500 rounded-full h-1.5 w-1.5" style="animation-delay: 0.2s;"></div>
                <span class="text-gray-400 text-xs ml-2">Thinking...</span>
            </div>
        </div>
    </div>

    <!-- Floating Button -->
    <button id="chatbot-toggle" 
            class="bg-pink-600 hover:bg-pink-700 text-white rounded-full p-4 shadow-2xl 
                   transition-all hover:scale-110 group animate-pulse-slow">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
        </svg>

        <span class="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-gray-800 text-white px-3 py-2 
                     rounded-lg text-sm whitespace-nowrap opacity-0 group-hover:opacity-100 
                     transition-opacity pointer-events-none shadow-lg">
            Ask our AI Assistant
        </span>

        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 
                     flex items-center justify-center animate-pulse">
            AI
        </span>
    </button>
</div>

<style>
@keyframes pulse-slow {
    0%, 100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }
    50% { box-shadow: 0 0 0 15px rgba(236, 72, 153, 0); }
}
.animate-pulse-slow {
    animation: pulse-slow 2s infinite;
}
</style>

<script>
(function() {
    const container = document.getElementById('chatbot-container');
    const window = document.getElementById('chatbot-window');
    const toggle = document.getElementById('chatbot-toggle');
    const close = document.getElementById('chatbot-close');
    const messages = document.getElementById('chatbot-messages');
    const input = document.getElementById('chatbot-input');
    const sendBtn = document.getElementById('chatbot-send');
    const loading = document.getElementById('chatbot-loading');
    const quickQuestions = document.querySelectorAll('.chatbot-quick-question');

    // Toggle chatbot window
    toggle.addEventListener('click', () => {
        const isHidden = window.classList.contains('hidden');
        if (isHidden) {
            window.classList.remove('hidden');
            toggle.classList.add('hidden');
            input.focus();
        }
    });

    // Close chatbot
    close.addEventListener('click', () => {
        window.classList.add('hidden');
        toggle.classList.remove('hidden');
    });

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatMessage(text) {
        text = escapeHtml(text);
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        text = text.replace(/\n/g, '<br>');
        return text;
    }

    function addMessage(content, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start space-x-2 ' + (isUser ? 'justify-end' : '');
        
        if (isUser) {
            messageDiv.innerHTML = `
                <div class="bg-gradient-to-r from-pink-600 to-pink-700 rounded-2xl px-3 py-2 max-w-[85%]">
                    <p class="text-white text-sm">${escapeHtml(content)}</p>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="h-6 w-6 rounded-full bg-gradient-to-br from-pink-500 to-pink-600 flex items-center justify-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="bg-gray-800 rounded-2xl px-3 py-2 max-w-[85%] border border-gray-700">
                    <p class="text-gray-100 text-sm">${formatMessage(content)}</p>
                </div>
            `;
        }
        
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
    }

    async function sendMessage(message) {
        if (!message.trim()) return;

        addMessage(message, true);
        input.value = '';
        sendBtn.disabled = true;
        loading.classList.remove('hidden');

        try {
            const response = await fetch('{% url "chatbot_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();
            console.log('Chatbot API response:', data);

            // Handle the nested response format: {success: true, data: {response: "..."}}
            if (data.success && data.data && data.data.response) {
                addMessage(data.data.response, false);
            } else if (data.ok && data.data && data.data.response) {
                addMessage(data.data.response, false);
            } else if (data.response) {
                addMessage(data.response, false);
            } else {
                console.error('Unexpected response format:', data);
                addMessage('Sorry, I encountered an error. Please try again.', false);
            }
        } catch (error) {
            console.error('Chatbot error:', error);
            addMessage('Sorry, something went wrong. Please try again.', false);
        } finally {
            loading.classList.add('hidden');
            sendBtn.disabled = false;
            input.focus();
        }
    }

    // Event listeners
    sendBtn.addEventListener('click', () => {
        sendMessage(input.value);
    });

    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage(input.value);
        }
    });

    quickQuestions.forEach(btn => {
        btn.addEventListener('click', () => {
            sendMessage(btn.textContent.trim());
        });
    });
})();
</script>